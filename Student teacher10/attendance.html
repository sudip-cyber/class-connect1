<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Attendance Table</title>
  <style>
    :root{
      --bg:#e9f2ff;
      --card:#ffffff;
      --muted:#67809a;
      --accent:#2b6ef6;
      --success:#28a745;
      --danger:#dc3545;
      --warning:#f0ad4e;
      --radius:10px;
      --pad:20px;
    }
    html,body{height:100%;}
    body {
      font-family: Inter, Arial, Helvetica, sans-serif;
      background: linear-gradient(180deg,var(--bg),#f7fbff);
      padding: 28px;
      color: #1f2937;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--card);
      border-radius: var(--radius);
      padding: calc(var(--pad) + 8px);
      box-shadow: 0 10px 30px rgba(35,50,80,0.08);
      text-align: left;
      border: 1px solid rgba(20,40,80,0.04);
    }
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h2 { margin: 0; font-size:1.3rem; letter-spacing:0.2px; }
    .subtitle{color:var(--muted);font-size:0.95rem}
    .user-badge{font-size:0.85rem;padding:6px 10px;border-radius:999px;background:#f1f5ff;color:var(--accent);border:1px solid rgba(43,110,246,0.08)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn { padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform .08s ease, box-shadow .08s ease; display:inline-flex;align-items:center;gap:8px }
    .btn:active{transform:translateY(1px)}
    .btn:hover{box-shadow:0 6px 14px rgba(43,110,246,0.06)}
    .btn-add { background: var(--success); color: #fff; }
    .btn-add-col { background: var(--warning); color: #1f2937; }
    .btn-del { background: transparent; color: var(--danger); border:1px solid rgba(220,53,69,0.08); padding:6px 8px;border-radius:6px }
    .btn-del:hover{background:rgba(220,53,69,0.04)}
    .btn-del-col { background: transparent; color: var(--accent); border:1px solid rgba(43,110,246,0.08); padding:6px 8px;border-radius:6px }
  .date-header{display:flex;align-items:center;justify-content:center;gap:6px}
  .date-input{padding:6px;border-radius:6px;border:1px solid #e6eefb}
  .subject-input{padding:6px 10px;border-radius:8px;border:1px solid #e6eefb;min-width:200px;margin-right:8px}
    .btn-save { background: var(--accent); color: #fff; margin-top: 10px; }
    .fixed-input { width: 150px; min-width: 120px; max-width: 100%; padding: 6px; border-radius:6px;border:1px solid #e6eefb }
    input[type="text"], input[type="number"] { padding: 6px; border-radius:6px; border:1px solid #e6eefb }
    input[type="date"] { padding: 6px; border-radius:6px; border:1px solid #e6eefb }
    select.attendance-select { width: 64px; padding: 6px; border-radius:6px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 14px; table-layout: fixed; }
    th, td { border-bottom: 1px solid #eef6ff; padding: 10px 8px; text-align: center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    th { background: linear-gradient(180deg,#f8fbff,#ffffff); position:sticky; top:0; z-index:2; }
    thead th{font-weight:700;color:#16324a}
    tbody tr:nth-child(even) { background: #fbfdff; }
    tbody tr:hover{background:#f4fbff}
    .empty-state{padding:28px;text-align:center;color:var(--muted)}
    /* responsive */
    @media (max-width:720px){
      .top-row{flex-direction:column;align-items:stretch}
      .toolbar{justify-content:space-between}
      .subject-input{min-width:140px;width:100%}
      .fixed-input{width:120px}
      table{font-size:0.92rem}
      th,td{padding:8px}
    }
  </style>
</head>
<body>

<script src="includes/storage-shim.js"></script>
<div class="container">
  <div class="top-row">

    <div>
      <h2>Attendance Table</h2>
      <div class="subtitle"></div>
      <div class="btn-group" style="margin-top:10px; gap:8px;">
        <button class="students-btn btn" onclick="location.href='sstore.html'">Students</button>
  <button class="teachers-btn btn" onclick="try{localStorage.setItem('fromTStoreSource','attendance')}catch(e){};location.href='tstore1.html'">Other Teachers</button>
        <button class="attendance-btn btn" onclick="location.href='attendance.html'">Attendance</button>
        <button class="teachers-btn btn" onclick="location.href='tdetails.html'">Your Profile</button>
      </div>
    </div>
    <div class="toolbar">
      <div style="display:flex;align-items:center;gap:8px">
        <input id="subjectInput" class="subject-input" type="text" placeholder="Subject (optional)">
  <select id="subjectSelect" class="subject-input" style="min-width:160px"></select>
  <button id="addSubjectBtn" class="btn btn-add-col" onclick="addCurrentSubject()">âž• Add Subject</button>
  <button id="deleteSubjectBtn" class="btn btn-del" onclick="deleteSubjectRecords()" title="Delete all attendance records for selected subject">ðŸ—‘ Delete Subject Data</button>
      </div>
      <div id="userBadge" class="user-badge">&nbsp;</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-add" onclick="addRow()">âž• Add Row</button>
        <button class="btn btn-add-col" onclick="addDateColumn()">ðŸ“… Add Date</button>
      </div>
    </div>
  </div>
  <table id="attendanceTable">
    <thead>
      <tr id="headerRow">
        <th>Name</th>
        <th>Roll No.</th>
        <!-- Date columns will be inserted here -->
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- Rows will be inserted here -->
    </tbody>
  </table>
  <button class="btn btn-save" onclick="saveTable()">Save</button>
</div>

<script>
let dateColumns = [];
let teacherId = localStorage.getItem('currentUserId'); // Get teacher's ID from login

if (!teacherId) {
  // If no teacher id in localStorage, allow demo/guest mode instead of forcing a redirect.
  // This makes the page safer to open directly for testing. The original behavior
  // redirected to login; we keep that option but ask the user first.
  if (!confirm("No login detected. Continue in demo mode? (Cancel to go to login)")) {
    window.location.href = 'log.html';
  } else {
    teacherId = 'guest';
  }
}

// Show teacher/demo badge in the UI (element exists in the DOM)
try{
  const badge = document.getElementById('userBadge');
  if (badge) badge.textContent = (teacherId === 'guest') ? 'Demo Mode' : ('Logged in: ' + teacherId);
}catch(e){/* ignore if DOM not ready for some reason */}

function getStorageKey() {
  // include subject in the storage key so attendance is stored per teacher+subject
  try {
    const subjEl = document.getElementById('subjectInput');
    const raw = subjEl ? (subjEl.value || '') : '';
    const keySub = raw.trim() ? encodeURIComponent(raw.trim()) : 'default';
    return "attendanceTableData_" + teacherId + "_" + keySub;
  } catch (e) {
    return "attendanceTableData_" + teacherId + "_default";
  }
}

// Subjects list helpers (teacher-scoped)
function getSubjectsKey() {
  return 'attendanceSubjects_' + teacherId;
}
function loadSubjectsList() {
  try { return JSON.parse(localStorage.getItem(getSubjectsKey()) || '[]'); } catch (e) { return []; }
}
function saveSubjectsList(list) {
  try { localStorage.setItem(getSubjectsKey(), JSON.stringify(list || [])); } catch (e) {}
}
function saveSubjectToList(s) {
  if (!s) return;
  const list = loadSubjectsList();
  if (list.indexOf(s) === -1) {
    list.push(s);
    saveSubjectsList(list);
    populateSubjectSelect();
  }
}
function populateSubjectSelect() {
  const sel = document.getElementById('subjectSelect');
  const subjEl = document.getElementById('subjectInput');
  if (!sel) return;
  const list = loadSubjectsList();
  sel.innerHTML = '';
  if (!list.length) {
    const opt = document.createElement('option'); opt.value = ''; opt.textContent = '-- no saved subjects --'; sel.appendChild(opt);
  } else {
    const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='-- select subject --'; sel.appendChild(emptyOpt);
    list.forEach(s => {
      const opt = document.createElement('option'); opt.value = s; opt.textContent = s; sel.appendChild(opt);
    });
  }
  // If subjectInput has a value and matches, select it
  try { const cur = subjEl ? subjEl.value : ''; if (cur) sel.value = cur; } catch(e){}
}

function addCurrentSubject() {
  const subjEl = document.getElementById('subjectInput');
  if (!subjEl) return;
  const s = subjEl.value.trim();
  if (!s) { alert('Enter a subject name to add.'); return; }
  const list = loadSubjectsList();
  if (list.indexOf(s) !== -1) { alert('Subject already exists.'); return; }
  list.push(s);
  saveSubjectsList(list);
  populateSubjectSelect();
  // create empty storage for new subject so it exists separately
  const prevKey = getStorageKey();
  try { localStorage.setItem('attendanceTableData_' + teacherId + '_' + encodeURIComponent(s), JSON.stringify({ subject: s, dateColumns: [], rows: [] })); } catch (e) {}
  // select and load
  try { document.getElementById('subjectSelect').value = s; } catch (e) {}
  alert('Subject added. Now editing subject: ' + s);
  try{ localStorage.setItem('attendance_update_signal', Date.now().toString()); }catch(e){}
  loadTable();
}

// Master delete: remove all attendance records for the currently selected subject (keeps the subject in the list)
function deleteSubjectRecords() {
  const subjEl = document.getElementById('subjectInput');
  if (!subjEl) return;
  const s = subjEl.value.trim();
  const keySub = s ? encodeURIComponent(s) : 'default';
  const key = 'attendanceTableData_' + teacherId + '_' + keySub;
  if (!confirm(`Delete ALL attendance records for subject "${s || 'default'}"? This cannot be undone.`)) return;
  try {
    localStorage.removeItem(key);
  } catch (e) {
    console.error('Failed to remove subject data', e);
  }
  try{ localStorage.setItem('attendance_update_signal', Date.now().toString()); }catch(e){}
  // Reload the table for this subject (will show empty attendance rows)
  alert('All attendance records for subject "' + (s || 'default') + '" have been deleted.');
  loadTable();
}

function attendanceSelectHTML(selected='') {
  return `<select class="attendance-select">
            <option value=""></option>
            <option value="A" ${selected === 'A' ? 'selected' : ''}>A</option>
            <option value="P" ${selected === 'P' ? 'selected' : ''}>P</option>
          </select>`;
}

function addRow(name='', roll='', attendance=[]) {
  const tbody = document.getElementById('tableBody');
  const row = document.createElement('tr');

  // Name cell
  let td1 = document.createElement('td');
  td1.innerHTML = `<input type="text" class="fixed-input" placeholder="Name" value="${name}">`;
  row.appendChild(td1);

  // Roll No cell (text input, numbers only)
  let td2 = document.createElement('td');
  td2.innerHTML = `<input type="text" class="fixed-input" placeholder="Roll No." pattern="\\d*" value="${roll}" oninput="this.value=this.value.replace(/[^\\d]/g,'')">`;
  row.appendChild(td2);

  // Date columns
  for(let i=0; i<dateColumns.length; i++) {
    let td = document.createElement('td');
    // Support different shapes for stored attendance: either an object {date, value}
    // or a simple value string from older formats. Be defensive to avoid runtime errors.
    let val = '';
    if (attendance && attendance[i] !== undefined) {
      const item = attendance[i];
      val = (typeof item === 'object' && item !== null) ? (item.value || '') : String(item || '');
    }
    td.innerHTML = attendanceSelectHTML(val);
    row.appendChild(td);
  }

  // Delete row button
  let tdDel = document.createElement('td');
  tdDel.innerHTML = `<button class="btn btn-del" onclick="deleteRow(this)">Delete</button>`;
  row.appendChild(tdDel);

  tbody.appendChild(row);
  updateHeader();
}

function deleteRow(btn) {
  if (confirm("Are you sure you want to delete this row?")) {
    btn.closest('tr').remove();
  }
}

function addDateColumn(dateVal='') {
  dateColumns.push(dateVal);
  updateHeader();

  // Add cell to each row
  const tbody = document.getElementById('tableBody');
  for(let row of tbody.rows) {
    let td = document.createElement('td');
    td.innerHTML = attendanceSelectHTML();
    row.insertBefore(td, row.cells[row.cells.length-1]);
  }
}

function deleteDateColumn(idx) {
  // Guard against invalid indexes
  if (typeof idx !== 'number' || idx < 0 || idx >= dateColumns.length) return;
  // Ask for confirmation showing the date (if available)
  const delDate = dateColumns[idx] || '';
  if (!confirm(`Delete column${delDate ? ' for ' + delDate : ''}? This will remove all attendance entries for that date.`)) return;

  // Remove from model
  dateColumns.splice(idx, 1);
  updateHeader();

  // Remove the corresponding cell from each row (cells: 0=name,1=roll,2..dates,last=delete)
  const tbody = document.getElementById('tableBody');
  for(let row of tbody.rows) {
    const cellIndex = idx + 2;
    if (cellIndex >= 0 && cellIndex < row.cells.length) {
      row.deleteCell(cellIndex);
    }
  }

  // Persist the change immediately so deletion is not lost on refresh
  try{ saveTable(); }catch(e){/* ignore save errors */}
}

function updateHeader() {
  const headerRow = document.getElementById('headerRow');
  while(headerRow.cells.length > 2) {
    headerRow.deleteCell(2);
  }
  dateColumns.forEach((date, idx) => {
    let th = document.createElement('th');
    th.innerHTML = `<div class="date-header">
        <input class="date-input" type="date" value="${date}" onchange="setDateColumn(${idx}, this.value)">
        <button class="btn btn-del-col" title="Delete date ${date || ''}" onclick="deleteDateColumn(${idx})">ðŸ—‘</button>
      </div>`;
    headerRow.appendChild(th);
  });
  let thDel = document.createElement('th');
  thDel.textContent = '';
  headerRow.appendChild(thDel);
}

function setDateColumn(idx, value) {
  dateColumns[idx] = value;
}

// Save function: collects data and stores in localStorage under teacher-specific key
function saveTable() {
  const rows = document.querySelectorAll('#tableBody tr');
  let result = [];
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    let obj = {
      name: cells[0].querySelector('input').value.trim(),
      roll: cells[1].querySelector('input').value.trim(),
      attendance: []
    };
    for(let i=0; i<dateColumns.length; i++) {
      const select = cells[2+i].querySelector('select');
      obj.attendance.push({
        date: dateColumns[i],
        value: select ? select.value : ""
      });
    }
    result.push(obj);
  });
  // Save to localStorage under teacher-specific key
  const subject = (document.getElementById('subjectInput') && document.getElementById('subjectInput').value) ? document.getElementById('subjectInput').value.trim() : '';
  localStorage.setItem(getStorageKey(), JSON.stringify({
    subject: subject,
    dateColumns: dateColumns,
    rows: result
  }));
  // Signal other pages (student profile) that attendance data updated so they can refresh
  try{ localStorage.setItem('attendance_update_signal', Date.now().toString()); }catch(e){}
  alert("Data saved to local storage for your account!");
}

// Load from localStorage if exists, using teacher+subject-specific key
function loadTable() {
  // Prefer using global students registry (so names & rolls are consistent across teachers).
  const students = JSON.parse(localStorage.getItem('studentsData') || '[]');
  const data = localStorage.getItem(getStorageKey());
  const parsed = data ? JSON.parse(data) : { dateColumns: [], rows: [] };

  // Load date columns from this teacher's storage (if any)
  dateColumns = parsed.dateColumns || [];
  // Restore subject if present
  try{
    const subjEl = document.getElementById('subjectInput');
    if (subjEl) subjEl.value = parsed.subject || '';
  }catch(e){}
  updateHeader();
  document.getElementById('tableBody').innerHTML = '';

  if (students && students.length > 0) {
    // Build rows from global students list and merge in any attendance stored for this teacher
    students.forEach(s => {
      // studentsData may store roll as 'rollNumber' or 'roll'
      const rollVal = s.rollNumber || s.roll || '';
      const nameVal = s.name || '';
      // Find matching saved row for this teacher by roll
      let attendanceArr = [];
      if (parsed.rows && parsed.rows.length) {
        const matched = parsed.rows.find(r => (r.roll === rollVal) || (r.roll === (s.rollNumber || s.roll)));
        if (matched) attendanceArr = matched.attendance || [];
      }
      addRow(nameVal, rollVal, attendanceArr);
    });
  } else if (parsed.rows && parsed.rows.length) {
    // Fallback: if no global students registry, restore rows saved for this teacher
    parsed.rows.forEach(r => addRow(r.name, r.roll, r.attendance));
  } else {
    // No students and no saved rows â€” start with a single empty row
    addRow();
  }
}

// Initialize: populate subject list, wire subject controls, then load
populateSubjectSelect();

// Keep track of previous subject to warn about unsaved changes on switch
let prevSubject = document.getElementById('subjectInput') ? (document.getElementById('subjectInput').value || '') : '';

function confirmAndSwitchSubject(newSub) {
  if (newSub === prevSubject) return true;
  if (!confirm('Switching subject will load attendance for that subject and replace the current table. Unsaved changes will be lost. Continue?')) {
    // restore previous values
    const subjEl = document.getElementById('subjectInput');
    const sel = document.getElementById('subjectSelect');
    if (subjEl) subjEl.value = prevSubject;
    if (sel) sel.value = prevSubject || '';
    return false;
  }
  prevSubject = newSub;
  return true;
}

// Wire subject select -> input
const subjectSelectEl = document.getElementById('subjectSelect');
if (subjectSelectEl) {
  subjectSelectEl.addEventListener('change', function () {
    const val = subjectSelectEl.value || '';
    if (!confirmAndSwitchSubject(val)) return;
    const subjEl = document.getElementById('subjectInput');
    if (subjEl) subjEl.value = val;
    loadTable();
  });
}

// Wire input change: on blur or Enter, optionally switch subject
const subjectInputEl = document.getElementById('subjectInput');
if (subjectInputEl) {
  subjectInputEl.addEventListener('blur', function () {
    const val = subjectInputEl.value.trim();
    if (val === prevSubject) return;
    if (!confirmAndSwitchSubject(val)) return;
    try { subjectSelectEl.value = val || ''; } catch (e) {}
    loadTable();
  });
  subjectInputEl.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const val = subjectInputEl.value.trim();
      if (!confirmAndSwitchSubject(val)) return;
      saveSubjectToList(val);
      try { subjectSelectEl.value = val || ''; } catch (e) {}
      loadTable();
    }
  });
}

// Initialize
loadTable();

// If there is a one-time prefill stored (from registration), add it as a new row.
(function applyRegistrationPrefill(){
  try{
    const raw = localStorage.getItem('attendancePrefill');
    if (!raw) return;
    const obj = JSON.parse(raw || '{}');
    const name = obj.name || '';
    const roll = obj.roll || '';
    if (name || roll) {
      // If a global students registry exists, the student will be added from there when the page
      // loads, so we only apply the one-time prefill when there is no `studentsData`.
      const students = JSON.parse(localStorage.getItem('studentsData') || '[]');
      if (students && students.length) {
        // remove prefill to avoid re-applying later â€” studentsData covers it
        localStorage.removeItem('attendancePrefill');
        return;
      }
      // No global students list â€” add the prefill row so at least this page gets the new student
      addRow(name, roll, []);
      // remove prefill so it does not get applied again
      localStorage.removeItem('attendancePrefill');
      // Optionally, scroll the new row into view
      try{
        const tbody = document.getElementById('tableBody');
        if (tbody && tbody.lastElementChild) tbody.lastElementChild.scrollIntoView({behavior:'smooth', block:'center'});
      }catch(e){}
    }
  }catch(e){/* ignore malformed data */}
})();

// remove all keys whose parsed.subject equals 'IoT'
Object.keys(localStorage).filter(k => k.startsWith('attendanceTableData_')).forEach(k=>{
  try{
    const p = JSON.parse(localStorage.getItem(k)||'{}');
    if((p.subject||'').trim() === 'Subject') localStorage.removeItem(k);
  }catch(e){}
});
</script>
</body>
</html>
