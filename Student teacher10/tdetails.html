<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Details</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #a9ccef;
      display: flex;
      justify-content: center;
      padding: 50px 20px;
    }

    .container {
      background: #ffffff;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      padding: 30px;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    h2 {
      color: #333;
      margin-bottom: 30px;
    }

    img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid #d0e3fa;
      margin-bottom: 20px;
    }

    p {
      font-size: 16px;
      color: #555;
      margin: 10px 0;
    }

    .profile-info input[type="text"],
    .profile-info input[type="date"] {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
    }

    .btn-group {
      margin-top: 25px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    button {
      padding: 10px 20px;
      font-weight: bold;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .edit-btn {
      background-color: #007bff;
      color: white;
    }

    .edit-btn:hover {
      background-color: #0056b3;
    }

    .save-btn {
      background-color: #007bff;
      color: white;
    }

    .save-btn:hover {
      background-color: #0056b3;
    }

    .cancel-btn {
      background-color: #dc3545;
      color: white;
    }

    .cancel-btn:hover {
      background-color: #c82333;
    }

    .students-btn {
      background-color: #28a745;
      color: white;
    }

    .students-btn:hover {
      background-color: #1e7e34;
    }

    .teachers-btn {
      background-color: #6c757d;
      color: white;
    }

    .teachers-btn:hover {
      background-color: #5a6268;
    }
    .attendance-btn {
  background-color: #ffc107;
  color: #333;
}
.attendance-btn:hover {
  background-color: #e0a800;
}
/* Chat modal styles */
.modal-overlay-chat {
  position: fixed;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.0);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms ease;
}
.modal-overlay-chat.open{ background: rgba(0,0,0,0.45); opacity: 1; pointer-events: auto; }
.modal-chat {
  background: #fff;
  border-radius: 12px;
  width: 720px;
  max-width: 96%;
  padding: 14px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.2);
  transform: translateY(8px) scale(0.98);
  opacity: 0;
  transition: transform 220ms cubic-bezier(.2,.9,.3,1), opacity 220ms ease;
}
.modal-overlay-chat.open .modal-chat{ transform: translateY(0) scale(1); opacity: 1; }
.modal-chat .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.modal-chat .close-btn{background:#eee;border-radius:6px;border:none;padding:6px 10px;cursor:pointer}

  </style>
</head>
<body>

<script src="includes/storage-shim.js"></script>


  <div class="container">
  <h2>Teacher Profile Details</h2>
  <div id="details">Loading...</div>
  
</div>

<!-- Chat area for teacher -->
<!-- Chat modal popup (hidden until messaging button clicked) -->
<div id="chatModal" class="modal-overlay-chat" onclick="if(event.target===this) closeChatModal()">
  <div class="modal-chat" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div style="font-weight:700">Chat with Student</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="studentSelect" style="padding:6px;border-radius:6px;border:1px solid #d0e3fa"></select>
        <button class="close-btn" aria-label="Close chat" onclick="closeChatModal()">âœ•</button>
      </div>
    </div>
    <div id="messagesBoxT" style="background:#fff;border-radius:10px;padding:12px;height:320px;overflow:auto;border:1px solid #d0e3fa"></div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <input id="chatInputT" type="text" placeholder="Type a message" style="flex:1;padding:8px;border-radius:8px;border:1px solid #d0e3fa" />
      <input id="fileInputT" type="file" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
      <label style="font-size:13px;display:flex;align-items:center;gap:6px;margin-left:6px"><input id="broadcastAllT" type="checkbox" /> Send to all students</label>
      <label style="font-size:13px;display:flex;align-items:center;gap:6px;margin-left:6px"><input id="broadcastAllBothT" type="checkbox" /> Send to all teachers & students</label>
      <button class="save-btn" onclick="sendChatMessageTeacher()" style="padding:8px 12px;border-radius:8px">Send</button>
    </div>
    <div id="selectionToolbarT" style="display:none;margin-top:8px;align-items:center;gap:8px;max-width:100%;">
      <span id="selectionCountT" style="font-weight:600;margin-right:8px"></span>
      <button class="save-btn" id="bulkDeleteForMeT">Delete for me</button>
      <button class="save-btn" id="bulkDeleteForEveryoneT">Delete for everyone</button>
      <button class="edit-btn" id="cancelSelectionT">Cancel</button>
    </div>
  </div>
</div>

<!-- Modal for other teachers -->
<div id="teachersModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <button id="modalClose" class="modal-close" title="Close">âœ•</button>
    <h3>Other Teachers</h3>
    <div id="modalContent" class="modal-content">
      <!-- teacher list injected here -->
    </div>
  </div>
</div>

<script>
  window.onload = function () {
    const loggedInId = localStorage.getItem('currentUserId');
    if (!loggedInId) {
      alert("Please log in first!");
      window.location.href = 'log.html';
      return;
    }

    const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
    const teacherProfile = teachers.find(teacher => teacher.id === loggedInId);

    const detailsDiv = document.getElementById('details');

    if (teacherProfile) {
      displayTeacherDetails(teacherProfile);
    } else {
      alert("No profile found for the logged-in Teacher ID.");
      window.location.href = 'tprofile2.html';
    }
  };

  let isEditing = false;

  function displayTeacherDetails(data) {
    const detailsHTML = `
        <div class="btn-group" style="justify-content:center;margin-bottom:18px;">
          <button class="edit-btn" onclick="editProfile()">Edit</button>
          <button class="students-btn" onclick="viewStudents()">Students</button>
          <button class="teachers-btn" onclick="viewTeachers()">Other Teachers</button>
          <button class="teachers-btn" id="messagingToggleBtnT" onclick="toggleMessaging()">Messaging</button>
          <button class="attendance-btn" onclick="goToAttendance()">Attendance</button>
          <button class="teachers-btn" onclick="location.href='tdetails.html'">Your Profile</button>
          <button class="cancel-btn" onclick="logout()" style="margin-left:6px">Logout</button>
        </div>
      <img src="${data.photoData}" alt="Profile Picture">
      <p><strong>Name:</strong> ${data.name}</p>
      <p><strong>Date of Birth:</strong> ${data.dob}</p>
      <p><strong>Passing Institute:</strong> ${data.institute}</p>
      <p><strong>Passing Year:</strong> ${data.year}</p>
    `;

    document.getElementById('details').innerHTML = detailsHTML;
  }

  function editProfile() {
    if (isEditing) return;

    isEditing = true;

    const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
    const teacherProfile = teachers.find(teacher => teacher.id === localStorage.getItem('currentUserId'));

    const editHTML = `
      <div class="btn-group" style="justify-content:center;margin-bottom:18px;">
        <button class="save-btn" onclick="saveChanges()">Save Changes</button>
        <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
        <button class="attendance-btn" onclick="goToAttendance()">Attendance</button>
      </div>
      <img src="${teacherProfile.photoData}" alt="Profile Picture">
      <div class="profile-info">
        <input type="text" id="editName" value="${teacherProfile.name}" />
        <p><strong>Date of Birth:</strong> <input type="date" id="editDob" value="${teacherProfile.dob}" /></p>
        <p><strong>Passing Institute:</strong> <input type="text" id="editInstitute" value="${teacherProfile.institute}" /></p>
        <p><strong>Passing Year:</strong> <input type="text" id="editYear" value="${teacherProfile.year}" /></p>
      </div>
    `;

    document.getElementById('details').innerHTML = editHTML;
  }

  function saveChanges() {
    const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
    const teacherProfile = teachers.find(teacher => teacher.id === localStorage.getItem('currentUserId'));

    if (teacherProfile) {
      teacherProfile.name = document.getElementById('editName').value;
      teacherProfile.dob = document.getElementById('editDob').value;
      teacherProfile.institute = document.getElementById('editInstitute').value;
      teacherProfile.year = document.getElementById('editYear').value;

      localStorage.setItem('teachers', JSON.stringify(teachers));
      displayTeacherDetails(teacherProfile);
      isEditing = false;
    }
  }

  function cancelEdit() {
    const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
    const teacherProfile = teachers.find(teacher => teacher.id === localStorage.getItem('currentUserId'));
    displayTeacherDetails(teacherProfile);
    isEditing = false;
  }

  function viewStudents() {
    window.location.href = 'sstore.html';
  }

  function viewTeachers() {
    try { localStorage.setItem('fromTStoreSource', 'tdetails'); } catch (e) {}
    window.location.href = 'tstore1.html';
  }
  function goToAttendance() {
  window.location.href = 'attendance.html';
  }

  function logout() {
    try {
      // remove common session keys (keep stored profiles and app data intact)
      Object.keys(localStorage).forEach(function(k){
        try{
          if(k === 'currentUserId' || k === 'currentUserRole' || k === 'isLoggedIn' || k.startsWith('session') || k.startsWith('current')){
            localStorage.removeItem(k);
          }
        }catch(e){}
      });
      try{ sessionStorage.clear(); }catch(e){}
      try{ localStorage.setItem('logout_signal', Date.now().toString()); }catch(e){}
    } catch (e) {}
    window.location.href = 'index.html';
  }

  // open chat modal when messaging button clicked
  function toggleMessaging(){
    try{
      const m = document.getElementById('chatModal'); if(!m) return; m.classList.add('open');
      // attempt to trigger a fresh render/load if helpers exposed
      try{ if(window.loadStudentsTeacher) window.loadStudentsTeacher(); }catch(e){}
      try{ if(window.renderMessagesTeacher) window.renderMessagesTeacher(); }catch(e){}
      // focus input lightly
      try{ setTimeout(()=>{ const ci=document.getElementById('chatInputT'); if(ci) ci.focus(); },120); }catch(e){}
    }catch(e){}
  }

  function closeChatModal(){ try{ const m=document.getElementById('chatModal'); if(m) m.classList.remove('open'); }catch(e){} }

  // --- Chat implementation for teacher page ---
  (function(){
    const studentSelect = document.getElementById('studentSelect');
    const messagesBox = document.getElementById('messagesBoxT');
    const chatInput = document.getElementById('chatInputT');
    const fileInput = document.getElementById('fileInputT');
    let currentStudentId = null;
    // selection state
    const selectedMsgsT = new Set();
    const selectionToolbarT = document.getElementById('selectionToolbarT');
    const selectionCountT = document.getElementById('selectionCountT');
    const bulkDeleteForMeT = document.getElementById('bulkDeleteForMeT');
    const bulkDeleteForEveryoneT = document.getElementById('bulkDeleteForEveryoneT');
    const cancelSelectionT = document.getElementById('cancelSelectionT');
    function updateSelectionUIT(){
      const n = selectedMsgsT.size;
      if(n>0){ selectionToolbarT.style.display='flex'; selectionCountT.textContent = n + ' selected'; } else { selectionToolbarT.style.display='none'; }
      // enable delete-for-everyone only if all selected messages are from current teacher
      try{
        const teacherId = localStorage.getItem('currentUserId');
        let allMine = true; if(n===0) allMine=false;
        selectedMsgsT.forEach(id=>{
          const key = chatKey(teacherId, currentStudentId);
          const raw = localStorage.getItem(key) || '[]'; let msgs = [];
          try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
          const m = msgs.find(x=>x.id===id);
          if(!m || String(m.senderId)!==String(teacherId)) allMine=false;
        });
        // show/hide bulk "Delete for everyone" button depending on ownership
        if(allMine){
          bulkDeleteForEveryoneT.style.display = 'inline-block';
          bulkDeleteForEveryoneT.disabled = false;
        } else {
          bulkDeleteForEveryoneT.style.display = 'none';
        }
      }catch(e){ bulkDeleteForEveryoneT.disabled = true; }
    }

    function escapeHtml(str){ return String(str||'').replace(/[&<>'"]/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;',"'":"&#39;","\"":"&quot;"}[m];}); }

    function chatKey(a,b){ try{ const arr=[String(a),String(b)].sort(); return 'chat_'+arr.join('_'); }catch(e){return null} }

    function loadStudents(){
      const keys = Object.keys(localStorage).filter(k=>k.startsWith('user_'));
      studentSelect.innerHTML = '';
      if(!keys.length){ studentSelect.innerHTML = '<option value="">-- no students --</option>'; return; }
      keys.forEach(k=>{
        try{
          const u = JSON.parse(localStorage.getItem(k) || '{}');
          const id = k.slice(5); // suffix after 'user_'
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = u.name || u.rollNo || id;
          studentSelect.appendChild(opt);
        }catch(e){ /* ignore malformed */ }
      });
      if(!studentSelect.value) studentSelect.selectedIndex = 0;
      currentStudentId = studentSelect.value;
    }

    function renderMessages(){
      messagesBox.innerHTML = '';
      const teacherId = localStorage.getItem('currentUserId');
      if(!teacherId || !currentStudentId) return;
      const key = chatKey(teacherId, currentStudentId);
      if(!key) return;
      let msgs = [];
      try{ msgs = JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ msgs = []; }
      // load hidden-for-me list
      const hiddenKey = 'chat_hidden_' + String(teacherId) + '_' + key;
      let hidden = [];
      try{ hidden = JSON.parse(localStorage.getItem(hiddenKey) || '[]'); }catch(e){ hidden = []; }
      msgs.forEach(m=>{
        if(hidden && Array.isArray(hidden) && hidden.indexOf(m.id) !== -1) return;
  const wrap = document.createElement('div'); wrap.style.marginBottom='8px'; wrap.dataset.msgId = m.id;
        const who = (m.senderId === teacherId) ? 'You' : (m.senderName || 'Student');
        const time = new Date(m.ts).toLocaleString();
        let inner = `<div style="font-size:12px;color:#666;margin-bottom:4px">${escapeHtml(who)} Â· ${time}</div>`;
        if(m.type === 'text') inner += `<div style="background:${m.senderId===teacherId?'#e6f7ff':'#f1f5f9'};padding:8px;border-radius:8px">${escapeHtml(m.content)}</div>`;
        else if(m.type === 'image') inner += `<div><img src="${m.data}" style="max-width:220px;border-radius:8px"/></div>`;
        else if(m.type === 'video') inner += `<div><video controls src="${m.data}" style="max-width:320px;border-radius:8px"></video></div>`;
        else if(m.type === 'file') inner += `<div><a href="${m.data}" download="${m.filename}">ðŸ“Ž ${escapeHtml(m.filename||'file')}</a></div>`;
        wrap.innerHTML = inner;
        // toggle selection on click
        wrap.onclick = function(e){
          try{
            const id = m.id;
            if(selectedMsgsT.has(id)) { selectedMsgsT.delete(id); wrap.style.outline='none'; }
            else { selectedMsgsT.add(id); wrap.style.outline='2px solid #007bff'; }
            updateSelectionUIT();
          }catch(e){}
        };
        messagesBox.appendChild(wrap);
      });
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    function sendChatMessageTeacher(){
      const teacherId = localStorage.getItem('currentUserId');
      if(!teacherId){ alert('No teacher logged in'); return; }
      if(!currentStudentId){ alert('Select a student'); return; }
      const text = chatInput.value.trim();
      const file = fileInput.files && fileInput.files[0];
      if(!text && !file) return;
      const doBroadcast = !!document.getElementById('broadcastAllT') && document.getElementById('broadcastAllT').checked;
      const doBroadcastBoth = !!document.getElementById('broadcastAllBothT') && document.getElementById('broadcastAllBothT').checked;
      const baseMsg = { id: Date.now() + '_' + Math.random().toString(36).slice(2,8), senderId: teacherId, senderName: 'Teacher', ts: Date.now() };
      if(doBroadcast || doBroadcastBoth){
        // send to all students
        // build recipients list: all students and optionally all teachers
        const recipients = [];
        const keys = Object.keys(localStorage).filter(k=>k.startsWith('user_'));
        keys.forEach(k=>{ const studentId = k.slice(5); if(studentId && String(studentId)!==String(teacherId)) recipients.push(String(studentId)); });
        if(doBroadcastBoth){
          const teachers = JSON.parse(localStorage.getItem('teachers')||'[]');
          teachers.forEach(t=>{ if(t && t.id && String(t.id)!==String(teacherId)) recipients.push(String(t.id)); });
        }
        const uniq = Array.from(new Set(recipients));
        if(!uniq.length) return;
        if(file){
          const reader = new FileReader();
          reader.onload = function(ev){
            const data = ev.target.result; const type = file.type||''; let mtype='file'; if(type.startsWith('image/')) mtype='image'; else if(type.startsWith('video/')) mtype='video';
            uniq.forEach(rid=>{
              try{
                const key = chatKey(teacherId, rid);
                const raw = localStorage.getItem(key) || '[]'; let msgs = [];
                try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
                const msg = Object.assign({}, baseMsg, { type: mtype, data: data, filename: file.name, mime: file.type }); msgs.push(msg);
                localStorage.setItem(key, JSON.stringify(msgs));
              }catch(e){}
            });
            try{ localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){}
            fileInput.value=''; chatInput.value=''; renderMessages();
          };
          reader.readAsDataURL(file);
        } else {
          uniq.forEach(rid=>{
            try{
              const key = chatKey(teacherId, rid);
              const raw = localStorage.getItem(key) || '[]'; let msgs = [];
              try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
              const msg = Object.assign({}, baseMsg, { type: 'text', content: text }); msgs.push(msg);
              localStorage.setItem(key, JSON.stringify(msgs));
            }catch(e){}
          });
          try{ localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){}
          chatInput.value=''; renderMessages();
        }
      } else {
        const key = chatKey(teacherId, currentStudentId);
        let msgs = [];
        try{ msgs = JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ msgs = []; }
        if(file){
          const reader = new FileReader();
          reader.onload = function(ev){ const data = ev.target.result; const type = file.type||''; let mtype='file'; if(type.startsWith('image/')) mtype='image'; else if(type.startsWith('video/')) mtype='video'; const msg = Object.assign({}, baseMsg, { type: mtype, data: data, filename: file.name, mime: file.type }); msgs.push(msg); try{ localStorage.setItem(key, JSON.stringify(msgs)); localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){ alert('Failed to save message (storage full?)'); } fileInput.value=''; chatInput.value=''; renderMessages(); };
          reader.readAsDataURL(file);
        } else {
          const msg = Object.assign({}, baseMsg, { type: 'text', content: text }); msgs.push(msg);
          try{ localStorage.setItem(key, JSON.stringify(msgs)); localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){ alert('Failed to save message (storage full?)'); }
          chatInput.value=''; renderMessages();
        }
      }
    }

    // delete helpers (teacher)
    function showDeleteOptions(chatStorageKey, msgId, anchorEl){
      try{
        const existing = document.getElementById('deleteMenu_'+msgId);
        if(existing){ existing.remove(); return; }
        const menu = document.createElement('div');
        menu.id = 'deleteMenu_'+msgId; menu.style.display='inline-block'; menu.style.marginLeft='8px';
        const btn1 = document.createElement('button'); btn1.textContent='Delete for me'; btn1.style.marginRight='6px';
        // check if current user is the sender for this message
        let isSender = false;
        try{
          const raw = localStorage.getItem(chatStorageKey) || '[]'; const msgs = JSON.parse(raw);
          const found = (msgs || []).find(x=>x && x.id === msgId);
          const me = localStorage.getItem('currentUserId');
          if(found && me && String(found.senderId) === String(me)) isSender = true;
        }catch(e){ isSender = false; }
        btn1.onclick = function(e){ e.stopPropagation(); deleteForMe(chatStorageKey, msgId); menu.remove(); };
        menu.appendChild(btn1);
        if(isSender){
          const btn2 = document.createElement('button'); btn2.textContent='Delete for everyone';
          btn2.onclick = function(e){ e.stopPropagation(); deleteForEveryone(chatStorageKey, msgId); menu.remove(); };
          menu.appendChild(btn2);
        }
        anchorEl.appendChild(menu);
        setTimeout(()=>{ try{ menu.remove(); }catch(e){} }, 8000);
      }catch(e){}
    }
    function deleteForMe(chatStorageKey, msgId){
      try{ const teacherId = localStorage.getItem('currentUserId'); if(!teacherId) return; const hiddenKey = 'chat_hidden_' + String(teacherId) + '_' + chatStorageKey; let arr = []; try{ arr = JSON.parse(localStorage.getItem(hiddenKey) || '[]'); }catch(e){ arr = []; } if(arr.indexOf(msgId) === -1) arr.push(msgId); localStorage.setItem(hiddenKey, JSON.stringify(arr)); renderMessages(); }catch(e){}
    }
    function deleteForEveryone(chatStorageKey, msgId){
      try{
        const raw = localStorage.getItem(chatStorageKey) || '[]'; let msgs = [];
        try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
        const me = localStorage.getItem('currentUserId');
        const target = (msgs || []).find(x=>x && x.id === msgId);
        if(!target) return;
        if(!me || String(target.senderId) !== String(me)){
          // not sender, fallback to delete-for-me
          deleteForMe(chatStorageKey, msgId);
          return;
        }
        let changed = false;
        for(let i=0;i<msgs.length;i++){
          if(msgs[i] && msgs[i].id === msgId){
            msgs[i].deleted = true;
            msgs[i].deletedBy = me || 'me';
            msgs[i].deletedTs = Date.now();
            msgs[i].type='text'; msgs[i].content='This message was deleted'; msgs[i].data=null; msgs[i].filename=null;
            changed=true; break;
          }
        }
        if(changed){ localStorage.setItem(chatStorageKey, JSON.stringify(msgs)); try{ localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){} renderMessages(); }
      }catch(e){}
    }
    // bulk handlers for teacher
    bulkDeleteForMeT.addEventListener('click', function(){ try{ const key = chatKey(localStorage.getItem('currentUserId'), currentStudentId); Array.from(selectedMsgsT).forEach(id=> deleteForMe(key, id)); selectedMsgsT.clear(); updateSelectionUIT(); renderMessages(); }catch(e){} });
    bulkDeleteForEveryoneT.addEventListener('click', function(){ try{ const key = chatKey(localStorage.getItem('currentUserId'), currentStudentId); Array.from(selectedMsgsT).forEach(id=> deleteForEveryone(key, id)); selectedMsgsT.clear(); updateSelectionUIT(); renderMessages(); }catch(e){} });
    cancelSelectionT.addEventListener('click', function(){ selectedMsgsT.clear(); updateSelectionUIT(); renderMessages(); });

    studentSelect.addEventListener('change', function(){ currentStudentId = studentSelect.value; renderMessages(); });

    window.addEventListener('storage', function(e){ if(!e.key) return; if(e.key.startsWith('chat_') || e.key === 'chat_update_signal'){ renderMessages(); } if(e.key && e.key.startsWith('user_')){ loadStudents(); renderMessages(); } });

    try{ loadStudents(); renderMessages(); }catch(e){}
    // expose helpers so the modal opener can refresh contents on open
    try{ window.loadStudentsTeacher = loadStudents; window.renderMessagesTeacher = renderMessages; }catch(e){}
    window.sendChatMessageTeacher = sendChatMessageTeacher;
    // ESC key closes modal when open
    try{ document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ closeChatModal(); } }); }catch(e){}
  })();

</script>

</body>
</html>
