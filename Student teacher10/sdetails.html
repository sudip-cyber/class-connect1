<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Details</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e0e5ec;
      margin: 0;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .card {
      background: #e0e5ec;
      border-radius: 20px;
      box-shadow: 8px 8px 15px #a3b1c6, -8px -8px 15px #ffffff;
      padding: 30px;
      width: 100%;
      max-width: 800px;
      display: flex;
      gap: 30px;
      align-items: center;
      margin-bottom: 30px;
    }

    .profile-photo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid #d1d9e6;
    }

    .profile-info p {
      margin: 8px 0;
      font-size: 15px;
      color: #333;
    }

    .profile-info input[type="text"],
    .profile-info input[type="date"] {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
    }

    .buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      padding: 12px 22px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 4px 4px 8px #a3b1c6, -4px -4px 8px #ffffff;
    }

    .logout-btn {
      background-color: #ff4e4e;
      color: white;
    }

    .logout-btn:hover {
      background-color: #e04343;
    }

    .viewo-btn,
    .teachers-btn {
      background-color: #4285f4;
      color: white;
    }

    .viewo-btn:hover,
    .teachers-btn:hover {
      background-color: #3367d6;
    }

    .edit-btn {
      background-color: #34c759;
      color: white;
    }

    .edit-btn:hover {
      background-color: #2e9a4d;
    }

    .save-btn {
      background-color: #007bff;
      color: white;
    }

    .save-btn:hover {
      background-color: #0056b3;
    }

    .error {
      background-color: #ffe4e4;
      color: #a00;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 4px 4px 8px #ccc;
    }
    /* Chat modal styles */
    .modal-overlay-chat {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.0);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    .modal-overlay-chat.open{ background: rgba(0,0,0,0.45); opacity: 1; pointer-events: auto; }
    .modal-chat {
      background: #fff;
      border-radius: 12px;
      width: 820px;
      max-width: 96%;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
      transform: translateY(8px) scale(0.98);
      opacity: 0;
      transition: transform 220ms cubic-bezier(.2,.9,.3,1), opacity 220ms ease;
    }
    .modal-overlay-chat.open .modal-chat{ transform: translateY(0) scale(1); opacity: 1; }
    .modal-chat .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal-chat .close-btn{background:#eee;border-radius:6px;border:none;padding:6px 10px;cursor:pointer}
    /* Attendance detail modal */
    .att-modal-overlay{ position: fixed; left:0;top:0;right:0;bottom:0; display:flex;align-items:center;justify-content:center; background:rgba(0,0,0,0.45); z-index:10000; visibility:hidden; opacity:0; transition:opacity 160ms ease,visibility 160ms; }
    .att-modal-overlay.open{ visibility:visible; opacity:1; }
    .att-modal{ background:#fff;border-radius:10px; max-width:720px; width:96%; padding:16px; box-shadow:0 14px 40px rgba(0,0,0,0.25); max-height:80vh; overflow:auto }
    .att-modal h4{ margin:0 0 8px 0 }
    .att-modal .att-list{ display:flex; flex-direction:column; gap:6px; margin-top:10px }
    .att-modal .att-row{ display:flex; justify-content:space-between; gap:12px; padding:8px; border-radius:6px; background:#f6f8fb }
    /* Class routine modal */
    .routine-overlay{ position: fixed; left:0;top:0;right:0;bottom:0; display:flex;align-items:center;justify-content:center; background:rgba(0,0,0,0.5); z-index:11000; visibility:hidden; opacity:0; transition:opacity 160ms ease,visibility 160ms; }
    .routine-overlay.open{ visibility:visible; opacity:1; }
    .routine-modal{ background:#fff;border-radius:10px; max-width:900px; width:96%; padding:12px; box-shadow:0 20px 60px rgba(0,0,0,0.35); max-height:90vh; overflow:auto }
    .routine-modal img{ width:100%; height:auto; display:block; border-radius:6px }
    .routine-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px }
  </style>
</head>
<body>

<script src="includes/storage-shim.js"></script>


<h2>Your Profile Details</h2>

<div class="buttons" style="width:100%;max-width:800px;display:flex;justify-content:flex-end;gap:12px;margin-bottom:18px;">
  <button class="viewo-btn" onclick="goToViewO()">View Other Profiles</button>
  <button class="teachers-btn" onclick="viewTeachers()">Teachers</button>
  <!-- Calendar / Class routine button -->
  <button title="Class Routine" id="classRoutineBtn" style="background:#fff;border:1px solid #d0d7e6;padding:10px 12px;border-radius:10px;display:flex;align-items:center;gap:8px;">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0b5fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
    <span style="color:#0b5fff;font-weight:600">Routine</span>
  </button>
  <button class="viewo-btn" id="messagingToggleBtn" onclick="toggleMessaging()">Messaging</button>
  <button class="viewo-btn" onclick="location.href='sdetails.html'">My Profile</button>
  <button class="edit-btn" onclick="editProfile()">Edit Profile</button>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div id="userDetails">
  <!-- Profile card will be injected here -->
</div>

<!-- Chat modal popup (hidden until messaging button clicked) -->
<div id="chatModal" class="modal-overlay-chat" onclick="if(event.target===this) closeChatModal()">
  <div class="modal-chat" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div style="font-weight:700">Chat with Teacher</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="teacherSelect" style="padding:6px;border-radius:6px;border:1px solid #e6eefb"></select>
        <button class="close-btn" aria-label="Close chat" onclick="closeChatModal()">âœ•</button>
      </div>
    </div>
    <div id="messagesBox" style="background:#fff;border-radius:10px;padding:12px;height:320px;overflow:auto;border:1px solid #e6eefb"></div>
    <div id="selectionToolbar" style="display:none;margin-top:8px;align-items:center;gap:8px;max-width:100%;">
      <span id="selectionCount" style="font-weight:600;margin-right:8px"></span>
      <button class="save-btn" id="bulkDeleteForMe">Delete for me</button>
      <button class="save-btn" id="bulkDeleteForEveryone">Delete for everyone</button>
      <button class="edit-btn" id="cancelSelection">Cancel</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <input id="chatInput" type="text" placeholder="Type a message" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefb" />
      <input id="fileInput" type="file" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
      <label style="font-size:13px;display:flex;align-items:center;gap:6px;margin-left:6px"><input id="broadcastAll" type="checkbox" /> Send to all teachers</label>
      <label style="font-size:13px;display:flex;align-items:center;gap:6px;margin-left:6px"><input id="broadcastAllBoth" type="checkbox" /> Send to all teachers & students</label>
      <button class="save-btn" onclick="sendChatMessage()" style="padding:8px 12px;border-radius:8px">Send</button>
    </div>
  </div>
</div>
</div>

<!-- Class routine modal (shows uploaded or bundled image) -->
<div id="routineOverlay" class="routine-overlay" onclick="if(event.target===this) closeRoutineModal()">
  <div class="routine-modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h4 style="margin:0">Class Routine</h4>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="routineFileInput" type="file" accept="image/*" style="display:none" />
        <button onclick="document.getElementById('routineFileInput').click()" style="padding:6px 10px;border-radius:6px;border:none;background:#0b5fff;color:#fff;cursor:pointer">Upload Image</button>
        <button onclick="closeRoutineModal()" style="background:#eee;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">Close</button>
      </div>
    </div>
    <div id="routineContent" style="margin-top:12px">
      <div style="color:#666">No routine image uploaded yet. Click Upload Image to add.</div>
    </div>
    <div class="routine-actions">
      <button onclick="removeRoutineImage()" style="background:#ff4e4e;color:#fff;border:none;padding:8px 10px;border-radius:6px">Remove</button>
    </div>
  </div>
</div>

<script>
  window.onload = function () {
    const currentUserId = localStorage.getItem('currentUserId');

    if (!currentUserId) {
      alert("Please login first!");
      window.location.href = 'log.html';
      return;
    }

    const userData = JSON.parse(localStorage.getItem(`user_${currentUserId}`));

    if (userData) {
      displayUserDetails(userData);
      // Render attendance summary for this student
      renderAttendanceSummary(userData.rollNo);
    } else {
      document.getElementById('userDetails').innerHTML = `
        <div class="error">
          No profile data found. Please complete your profile first.
        </div>
      `;
    }
  };

  let isEditing = false;

  function displayUserDetails(data) {
    const detailsHTML = `
      <div class="card">
        <img src="${data.photoURL || 'placeholder.jpg'}" 
             class="profile-photo" 
             alt="Profile Photo" />
        <div class="profile-info">
          <h3 id="name">${data.name}</h3>
          <p><strong>Roll Number:</strong> <span id="rollNo">${data.rollNo}</span></p>
          <p><strong>DOB:</strong> <span id="dob">${data.dob}</span></p>
          <p><strong>Father's Name:</strong> <span id="fatherName">${data.fatherName}</span></p>
          <p><strong>Mother's Name:</strong> <span id="motherName">${data.motherName}</span></p>
          <p><strong>SGPA (1st Sem):</strong> <span id="sgpa1">${data.sgpa1 || 'N/A'}</span></p>
          <p><strong>SGPA (2nd Sem):</strong> <span id="sgpa2">${data.sgpa2 || 'N/A'}</span></p>
          <p><strong>SGPA (3rd Sem):</strong> <span id="sgpa3">${data.sgpa3 || 'N/A'}</span></p>
          <p><strong>Remarks:</strong> ${data.remarks || 'No remarks added'}</p>
        </div>
      </div>
      
      <div id="attendanceSummary" class="card" style="flex-direction:column;padding:18px;">
        <h3 style="margin:0 0 10px 0">Attendance Summary</h3>
        <div id="attendanceSummaryContent">Loading attendance...</div>
      </div>
      
    `;

    document.getElementById('userDetails').innerHTML = detailsHTML;
  }

  // Compute and render attendance summary for a given roll number
  function renderAttendanceSummary(rollNo) {
    const container = document.getElementById('attendanceSummaryContent');
    if (!container) return;
    try{
      // Iterate all attendance storage keys for teachers
      const summaryMap = {}; // subject -> {present, total}
      for (let i=0;i<localStorage.length;i++) {
        const key = localStorage.key(i);
        if (!key || !key.startsWith('attendanceTableData_')) continue;
        try{
          const raw = localStorage.getItem(key);
          if (!raw) continue;
          const parsed = JSON.parse(raw);
          const subject = (parsed.subject && parsed.subject.trim()) ? parsed.subject.trim() : ('Subject');
          const totalSessions = (parsed.dateColumns && parsed.dateColumns.length) ? parsed.dateColumns.length : 0;
          // find row for this roll
          const rows = parsed.rows || [];
          const matched = rows.find(r => String(r.roll) === String(rollNo) || String(r.rollNumber) === String(rollNo));
          if (!matched) continue;
          const attendanceArr = matched.attendance || [];
          // count presents
          let presentCount = 0;
          if (attendanceArr && attendanceArr.length) {
            for (const item of attendanceArr) {
              if (typeof item === 'object' && item !== null) {
                if ((item.value || '').toString().toUpperCase() === 'P') presentCount++;
              } else {
                if ((item || '').toString().toUpperCase() === 'P') presentCount++;
              }
            }
          }
          // If totalSessions is 0, fall back to attendanceArr length
          const total = totalSessions || (attendanceArr ? attendanceArr.length : 0);
          if (!summaryMap[subject]) summaryMap[subject] = { present: 0, total: 0 };
          summaryMap[subject].present += presentCount;
          summaryMap[subject].total += total;
        }catch(e){/* ignore parse errors for unrelated keys */}
      }

      // Render
      const entries = Object.keys(summaryMap);
      if (!entries.length) {
        container.innerHTML = '<div style="color:#666">No attendance records found for this student yet.</div>';
        return;
      }
        let html = '<div style="width:100%;display:flex;flex-direction:column;gap:8px">';
        entries.forEach(sub => {
          // skip placeholder/default subject entries named exactly 'Subject'
          try{ if(String(sub).trim().toLowerCase() === 'subject') return; }catch(e){}
          const s = summaryMap[sub];
          const pct = (s.total ? Math.round((s.present / s.total) * 100) : 0);
          // subject row uses data attribute so we can attach a click handler after rendering
          html += `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div class="subject-row" data-subject="${escapeHtml(sub)}" style="font-weight:600;cursor:pointer;color:#0b5fff;text-decoration:underline">${escapeHtml(sub)}</div>
            <div style="color:#333">${s.present} / ${s.total} (${pct}%)</div>
          </div>`;
        });
        html += '</div>';
        container.innerHTML = html;

        // attach click listeners to subject rows to show date-level details
        try{
          const rows = container.querySelectorAll('.subject-row');
          rows.forEach(r => {
            r.addEventListener('click', function(){
              const subj = r.dataset.subject;
              showAttendancePopup(subj, rollNo);
            });
          });
        }catch(e){}
    }catch(e){
      container.innerHTML = '<div style="color:#a00">Error loading attendance summary</div>';
    }
  }

  // Simple escape to avoid injecting arbitrary markup from subject names
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];});
  }

  // Show a modal with per-date attendance for a subject and a student rollNo.
  function showAttendancePopup(subject, rollNo){
    try{
      if(!subject) return;
      const list = [];
      // scan attendance storage keys for matching subject entries and the given student row
      for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(!key || !key.startsWith('attendanceTableData_')) continue;
        try{
          const parsed = JSON.parse(localStorage.getItem(key) || '{}');
          const subj = (parsed.subject && parsed.subject.trim())? parsed.subject.trim() : 'Subject';
          if(String(subj) !== String(subject)) continue;
          const rows = parsed.rows || [];
          const matched = rows.find(r => String(r.roll) === String(rollNo) || String(r.rollNumber) === String(rollNo));
          if(!matched) continue;
          const dates = parsed.dateColumns || [];
          const attendanceArr = matched.attendance || [];
          for(let j=0;j<dates.length;j++){
            const d = dates[j];
            let val = attendanceArr[j];
            if(typeof val === 'object' && val !== null) val = val.value || '';
            val = (val||'').toString().trim().toUpperCase();
            const present = (val === 'P' || val === '1' || val === 'YES');
            list.push({ date: d, status: present ? 'Present' : (val ? 'Absent' : 'No Data') });
          }
        }catch(e){ }
      }

      // Build modal content
      let modal = document.getElementById('attendanceModal');
      if(!modal){
        modal = document.createElement('div'); modal.id='attendanceModal'; modal.className='att-modal-overlay';
        modal.innerHTML = `<div class="att-modal" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h4 id="attModalTitle">Attendance details</h4>
              <button onclick="closeAttendanceModal()" style="background:#eee;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">Close</button>
            </div>
            <div id="attModalContent" class="att-list"></div>
          </div>`;
        document.body.appendChild(modal);
      }
      const title = modal.querySelector('#attModalTitle');
      const content = modal.querySelector('#attModalContent');
      title.textContent = `Dates for ${subject}`;
      if(!list.length){ content.innerHTML = '<div style="color:#666">No date-level records found for this subject and student.</div>'; }
      else{
        // sort by date if possible
        try{ list.sort((a,b)=> new Date(a.date) - new Date(b.date)); }catch(e){}
        let out = '';
        list.forEach(it => { out += `<div class="att-row"><div>${escapeHtml(it.date)}</div><div style="font-weight:700">${escapeHtml(it.status)}</div></div>`; });
        content.innerHTML = out;
      }
      // open modal
      setTimeout(()=>{ modal.classList.add('open'); },10);
      modal.classList.add('open');
      modal.onclick = function(e){ if(e.target === modal) closeAttendanceModal(); };
    }catch(e){ console.warn('showAttendancePopup error', e); }
  }

  function closeAttendanceModal(){ try{ const m=document.getElementById('attendanceModal'); if(m) m.classList.remove('open'); setTimeout(()=>{ try{ const mm=document.getElementById('attendanceModal'); if(mm) mm.remove(); }catch(e){} },220); }catch(e){} }

  // --- Class routine modal handlers ---
  function openRoutineModal(){
    try{
      const overlay = document.getElementById('routineOverlay');
      if(!overlay) return;
      // render image if stored
      renderRoutineImage();
      overlay.classList.add('open');
    }catch(e){console.warn(e)}
  }

  function closeRoutineModal(){ try{ const o=document.getElementById('routineOverlay'); if(o) o.classList.remove('open'); }catch(e){} }

  function renderRoutineImage(){
    try{
      const content = document.getElementById('routineContent');
      const data = localStorage.getItem('classRoutineImage');
      if(!content) return;
      if(!data){
        // show default routine.jpg shipped with the app (falls back to message if not found)
        content.innerHTML = `<img src="routine.jpg" alt="Class Routine" onerror="this.style.display='none';document.getElementById('routineContent').innerHTML='<div style=\"color:#666\">No routine image uploaded yet. Click Upload Image to add.</div>'" />`;
        return;
      }
      content.innerHTML = `<img src="${data}" alt="Class Routine" />`;
    }catch(e){ }
  }

  // file input handler - store as data URL
  try{
    const rf = document.getElementById('routineFileInput');
    if(rf){ rf.addEventListener('change', function(e){ const f = rf.files && rf.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = function(ev){ try{ localStorage.setItem('classRoutineImage', ev.target.result); renderRoutineImage(); }catch(e){ alert('Failed to save image'); } }; reader.readAsDataURL(f); }); }
  }catch(e){}

  function removeRoutineImage(){ try{ localStorage.removeItem('classRoutineImage'); renderRoutineImage(); }catch(e){} }

  // Refresh summary when attendance storage changes (other tabs). Also listen for the update signal.
  window.addEventListener('storage', function(e){
    if (!e.key) return;
    if (e.key.startsWith('attendanceTableData_') || e.key === 'attendance_update_signal' || e.key === 'studentsData' || (e.key && e.key.startsWith('user_'))){
      const currentUserId = localStorage.getItem('currentUserId');
      if (!currentUserId) return;
      const userData = JSON.parse(localStorage.getItem(`user_${currentUserId}`) || '{}');
      if (userData) {
        // refresh profile details
        try{ displayUserDetails(userData); }catch(e){}
        if (userData.rollNo) renderAttendanceSummary(userData.rollNo);
      }
    }
  });

  function editProfile() {
    if (isEditing) return;

    isEditing = true;

    const name = document.getElementById('name').textContent;
    const rollNo = document.getElementById('rollNo').textContent;
    const dob = document.getElementById('dob').textContent;
    const fatherName = document.getElementById('fatherName').textContent;
    const motherName = document.getElementById('motherName').textContent;
    const sgpa1 = document.getElementById('sgpa1').textContent;
    const sgpa2 = document.getElementById('sgpa2').textContent;
    const sgpa3 = document.getElementById('sgpa3').textContent;

    const editHTML = `
      <div class="card">
        <img src="placeholder.jpg" 
             class="profile-photo" 
             alt="Profile Photo" />
        <div class="profile-info">
          <input type="text" id="editName" value="${name}" />
          <p><strong>Roll Number:</strong> <input type="text" id="editRollNo" value="${rollNo}" /></p>
          <p><strong>DOB:</strong> <input type="date" id="editDob" value="${dob}" /></p>
          <p><strong>Father's Name:</strong> <input type="text" id="editFatherName" value="${fatherName}" /></p>
          <p><strong>Mother's Name:</strong> <input type="text" id="editMotherName" value="${motherName}" /></p>
          <p><strong>SGPA (1st Sem):</strong> <input type="text" id="editSgpa1" value="${sgpa1}" /></p>
          <p><strong>SGPA (2nd Sem):</strong> <input type="text" id="editSgpa2" value="${sgpa2}" /></p>
          <p><strong>SGPA (3rd Sem):</strong> <input type="text" id="editSgpa3" value="${sgpa3}" /></p>
          <p><strong>Remarks:</strong> ${document.getElementById('userDetails').querySelector('.profile-info').querySelectorAll('p')[7].textContent}</p>
          <button class="save-btn" onclick="saveChanges()">Save Changes</button>
          <button class="edit-btn" onclick="cancelEdit()">Cancel</button>
      </div>
      </div>
      
    `;

    document.getElementById('userDetails').innerHTML = editHTML;
  }

  function saveChanges() {
    const currentUserId = localStorage.getItem('currentUserId');
    const userData = JSON.parse(localStorage.getItem(`user_${currentUserId}`));

    if (userData) {
      userData.name = document.getElementById('editName').value;
      userData.rollNo = document.getElementById('editRollNo').value;
      userData.dob = document.getElementById('editDob').value;
      userData.fatherName = document.getElementById('editFatherName').value;
      userData.motherName = document.getElementById('editMotherName').value;
      userData.sgpa1 = document.getElementById('editSgpa1').value;
      userData.sgpa2 = document.getElementById('editSgpa2').value;
      userData.sgpa3 = document.getElementById('editSgpa3').value;

      localStorage.setItem(`user_${currentUserId}`, JSON.stringify(userData));
      displayUserDetails(userData);
      isEditing = false;
    }
  }

  function cancelEdit() {
    const currentUserId = localStorage.getItem('currentUserId');
    const userData = JSON.parse(localStorage.getItem(`user_${currentUserId}`));
    displayUserDetails(userData);
    isEditing = false;
  }

  function logout() {
    localStorage.removeItem('currentUserId');
    window.location.href = 'index.html';
  }

  function goToViewO() {
    window.location.href = 'viewo.html';
  }

  function viewTeachers() {
    try { localStorage.setItem('fromTStoreSource', 'sdetails'); } catch (e) {}
    window.location.href = 'tstore1.html';
  }

  // Toggle messaging UI visibility
  function toggleMessaging(){
    try{
      const m = document.getElementById('chatModal'); if(!m) return; m.classList.add('open');
      // attempt to trigger a fresh render/load if helpers exposed
      try{ if(window.loadTeachersStudent) window.loadTeachersStudent(); else if(typeof loadTeachers === 'function') loadTeachers(); }catch(e){}
      try{ if(window.renderMessagesStudent) window.renderMessagesStudent(); else if(typeof renderMessages === 'function') renderMessages(); }catch(e){}
      try{ setTimeout(()=>{ const ci=document.getElementById('chatInput'); if(ci) ci.focus(); },120); }catch(e){}
    }catch(e){}
  }

  function closeChatModal(){ try{ const m=document.getElementById('chatModal'); if(m) m.classList.remove('open'); }catch(e){} }

  // --- Chat implementation for student page ---
  (function(){
    const teacherSelect = document.getElementById('teacherSelect');
    const messagesBox = document.getElementById('messagesBox');
    const chatInput = document.getElementById('chatInput');
    const fileInput = document.getElementById('fileInput');
    let currentTeacherId = null;
    // selection state for bulk actions
    const selectedMsgs = new Set();
    const selectionToolbar = document.getElementById('selectionToolbar');
    const selectionCount = document.getElementById('selectionCount');
    const bulkDeleteForMeBtn = document.getElementById('bulkDeleteForMe');
    const bulkDeleteForEveryoneBtn = document.getElementById('bulkDeleteForEveryone');
    const cancelSelectionBtn = document.getElementById('cancelSelection');
    function updateSelectionUI(){
      const n = selectedMsgs.size;
      if(n>0){
        selectionToolbar.style.display = 'flex';
        selectionCount.textContent = n + ' selected';
      } else {
        selectionToolbar.style.display = 'none';
      }
      // enable/disable delete-for-everyone: only when all selected messages belong to current user
      try{
        const studentId = localStorage.getItem('currentUserId');
        let allMine = true;
        if(n===0) allMine = false;
        selectedMsgs.forEach(id=>{
          const key = chatKey(localStorage.getItem('currentUserId'), currentTeacherId);
          const raw = localStorage.getItem(key) || '[]'; let msgs = [];
          try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
          const m = msgs.find(x=>x.id===id);
          if(!m || String(m.senderId)!==String(studentId)) allMine = false;
        });
        // show/hide bulk "Delete for everyone" button depending on ownership
        if(allMine){
          bulkDeleteForEveryoneBtn.style.display = 'inline-block';
          bulkDeleteForEveryoneBtn.disabled = false;
        } else {
          bulkDeleteForEveryoneBtn.style.display = 'none';
        }
      }catch(e){ bulkDeleteForEveryoneBtn.disabled = true; }
    }

    function chatKey(a,b){
      try{ const arr=[String(a),String(b)].sort(); return 'chat_'+arr.join('_'); }catch(e){return null}
    }

    function loadTeachers(){
      const teachers = JSON.parse(localStorage.getItem('teachers')||'[]');
      teacherSelect.innerHTML = '';
      if(!teachers.length){ teacherSelect.innerHTML = '<option value="">-- no teachers --</option>'; return; }
      teachers.forEach(t => {
        const opt = document.createElement('option'); opt.value = t.id; opt.textContent = t.name || t.id; teacherSelect.appendChild(opt);
      });
      // select first by default
      if(!teacherSelect.value) teacherSelect.selectedIndex = 0;
      currentTeacherId = teacherSelect.value;
    }

    async function renderMessages(){
      messagesBox.innerHTML = '';
      const studentId = localStorage.getItem('currentUserId');
      if(!studentId || !currentTeacherId) return;
      // try server first
      try{
        const resp = await fetch('/database/api/chat.php?user_a='+encodeURIComponent(studentId)+'&user_b='+encodeURIComponent(currentTeacherId));
        if(resp && resp.ok){
          const j = await resp.json();
          if(j && j.success && Array.isArray(j.messages)){
            const msgs = j.messages;
            // local hidden list still respected
            const key = chatKey(studentId, currentTeacherId);
            const hiddenKey = 'chat_hidden_' + String(studentId) + '_' + key;
            let hidden = [];
            try{ hidden = JSON.parse(localStorage.getItem(hiddenKey) || '[]'); }catch(e){ hidden = []; }
            msgs.forEach(m => {
              if(hidden && Array.isArray(hidden) && hidden.indexOf(m.message_id || m.messageId || m.id) !== -1) return;
              const id = m.message_id || m.messageId || m.id;
              const wrap = document.createElement('div'); wrap.style.marginBottom='8px'; wrap.dataset.msgId = id;
              const who = (String((m.sender_id||m.senderId)) === String(studentId)) ? 'You' : (m.sender_name || 'Teacher');
              const time = new Date((m.ts||m.ts_ms||0)).toLocaleString();
              let inner = `<div style="font-size:12px;color:#666;margin-bottom:4px">${escapeHtml(who)} Â· ${time}</div>`;
              const mtype = m.msg_type || m.type || 'text';
              if(mtype === 'text') inner += `<div style="background:${String(m.sender_id)===String(studentId)?'#e6f7ff':'#f1f5f9'};padding:8px;border-radius:8px">${escapeHtml(m.content||m.content)}</div>`;
              else if(mtype === 'image') inner += `<div><img src="${m.content||''}" style="max-width:220px;border-radius:8px"/></div>`;
              else if(mtype === 'video') inner += `<div><video controls src="${m.content||''}" style="max-width:320px;border-radius:8px"></video></div>`;
              else if(mtype === 'file') inner += `<div><a href="${m.content||''}" download="${m.filename||''}">ðŸ“Ž ${escapeHtml(m.filename || 'file')}</a></div>`;
              wrap.innerHTML = inner;
              wrap.onclick = function(e){ try{ const id2 = id; if(selectedMsgs.has(id2)) selectedMsgs.delete(id2); else selectedMsgs.add(id2); if(selectedMsgs.has(id2)) wrap.style.outline='2px solid #007bff'; else wrap.style.outline='none'; updateSelectionUI(); }catch(e){} };
              messagesBox.appendChild(wrap);
            });
            messagesBox.scrollTop = messagesBox.scrollHeight;
            return;
          }
        }
      }catch(e){ /* server unavailable, fallback to localStorage */ }

      // fallback to localStorage for offline/compat
      const key = chatKey(studentId, currentTeacherId);
      if(!key) return;
      const raw = localStorage.getItem(key) || '[]';
      let msgs = [];
      try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
      const hiddenKey = 'chat_hidden_' + String(studentId) + '_' + key;
      let hidden = [];
      try{ hidden = JSON.parse(localStorage.getItem(hiddenKey) || '[]'); }catch(e){ hidden = []; }
      msgs.forEach(m => {
        if(hidden && Array.isArray(hidden) && hidden.indexOf(m.id) !== -1) return;
        const wrap = document.createElement('div');
        wrap.style.marginBottom = '8px';
        wrap.dataset.msgId = m.id;
        const who = (m.senderId === studentId) ? 'You' : (m.senderName || 'Teacher');
        const time = new Date(m.ts).toLocaleString();
        let inner = `<div style="font-size:12px;color:#666;margin-bottom:4px">${escapeHtml(who)} Â· ${time}</div>`;
        if(m.type === 'text'){
          inner += `<div style="background:${m.senderId===studentId?'#e6f7ff':'#f1f5f9'};padding:8px;border-radius:8px">${escapeHtml(m.content)}</div>`;
        } else if(m.type === 'image'){
          inner += `<div><img src="${m.data}" style="max-width:220px;border-radius:8px"/></div>`;
        } else if(m.type === 'video'){
          inner += `<div><video controls src="${m.data}" style="max-width:320px;border-radius:8px"></video></div>`;
        } else if(m.type === 'file'){
          inner += `<div><a href="${m.data}" download="${m.filename}">ðŸ“Ž ${escapeHtml(m.filename || 'file')}</a></div>`;
        }
        wrap.innerHTML = inner;
        wrap.onclick = function(e){
          try{
            const id = m.id;
            if(selectedMsgs.has(id)) selectedMsgs.delete(id); else selectedMsgs.add(id);
            if(selectedMsgs.has(id)) wrap.style.outline = '2px solid #007bff'; else wrap.style.outline = 'none';
            updateSelectionUI();
          }catch(e){}
        };
        messagesBox.appendChild(wrap);
      });
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    async function sendChatMessage(){
      const studentId = localStorage.getItem('currentUserId');
      if(!studentId) { alert('No student logged in'); return; }
      if(!currentTeacherId){ alert('Select a teacher'); return; }
      const text = chatInput.value.trim();
      const file = fileInput.files && fileInput.files[0];
      if(!text && !file) return;
      const doBroadcast = !!document.getElementById('broadcastAll') && document.getElementById('broadcastAll').checked;

      // prepare helper to send one message through API (falls back to localStorage on failure)
      const sendOne = async (a,b, senderId, senderName, mtype, content, filename, mime, ts) => {
        try{
          const payload = { user_a: a, user_b: b, sender_id: senderId, sender_type: 'student', sender_name: senderName, msg_type: mtype, content: content, filename: filename, mime: mime, ts: ts };
          const resp = await fetch('/database/api/chat.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const json = await resp.json();
          if(json && json.success && json.message){
            // success - nothing else needed, but update localStorage mirror for offline UI
            const key = chatKey(a,b);
            if(key){
              const raw = localStorage.getItem(key)||'[]'; let msgs = [];
              try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
              msgs.push({ id: json.message.message_id, senderId: senderId, senderName: senderName, ts: json.message.ts, type: json.message.msg_type, content: json.message.content, filename: json.message.filename, mime: json.message.mime });
              localStorage.setItem(key, JSON.stringify(msgs));
              try{ localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){}
            }
            return true;
          }
        }catch(err){ /* fallthrough to localStorage */ }
        // fallback - write to localStorage like before
        try{
          const key = chatKey(a,b);
          if(!key) return false;
          const raw = localStorage.getItem(key) || '[]'; let msgs = [];
          try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
          const fallbackId = Date.now() + '_' + Math.random().toString(36).slice(2,8);
          msgs.push({ id: fallbackId, senderId: senderId, senderName: senderName, ts: ts, type: mtype, content: content, filename: filename, mime: mime });
          localStorage.setItem(key, JSON.stringify(msgs));
          try{ localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){}
          return true;
        }catch(e){ return false; }
      };

      const tsNow = Date.now();
      if(doBroadcast){
        const teachers = JSON.parse(localStorage.getItem('teachers')||'[]');
        if(!teachers.length) return;
        if(file){
          const reader = new FileReader();
          reader.onload = async function(ev){
            const data = ev.target.result; const type = file.type||''; let mtype='file'; if(type.startsWith('image/')) mtype='image'; else if(type.startsWith('video/')) mtype='video';
            for(const t of teachers){
              await sendOne(studentId, t.id, studentId, 'Student', mtype, data, file.name, file.type, tsNow);
            }
            fileInput.value=''; chatInput.value=''; renderMessages();
          };
          reader.readAsDataURL(file);
        } else {
          for(const t of teachers){ await sendOne(studentId, t.id, studentId, 'Student', 'text', text, null, null, tsNow); }
          chatInput.value=''; renderMessages();
        }
      } else {
        if(file){
          const reader = new FileReader();
          reader.onload = async function(ev){ const data = ev.target.result; const type = file.type || ''; let mtype='file'; if(type.startsWith('image/')) mtype='image'; else if(type.startsWith('video/')) mtype='video'; await sendOne(studentId, currentTeacherId, studentId, 'Student', mtype, data, file.name, file.type, tsNow); fileInput.value=''; chatInput.value=''; renderMessages(); };
          reader.readAsDataURL(file);
        } else {
          await sendOne(studentId, currentTeacherId, studentId, 'Student', 'text', text, null, null, tsNow);
          chatInput.value = ''; renderMessages();
        }
      }
    }

    teacherSelect.addEventListener('change', function(){ currentTeacherId = teacherSelect.value; renderMessages(); });

    window.addEventListener('storage', function(e){
      if(!e.key) return;
      if(e.key.startsWith('chat_') || e.key === 'chat_update_signal'){
        renderMessages();
      }
      if(e.key && e.key.startsWith('teachers')){
        loadTeachers(); renderMessages();
      }
      if(e.key && e.key.startsWith('user_')){
        renderMessages();
      }
    });

  // init
  try{ loadTeachers(); renderMessages(); }catch(e){}
  // expose sendChatMessage globally and helpers for modal open
  window.sendChatMessage = sendChatMessage;
  try{ window.loadTeachersStudent = loadTeachers; window.renderMessagesStudent = renderMessages; }catch(e){}
  // ESC key closes modal when open
  try{ document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ closeChatModal(); } }); }catch(e){}

  // wire routine button after DOM ready
  try{ document.getElementById('classRoutineBtn').addEventListener('click', openRoutineModal); }catch(e){}

    // --- Delete helpers ---
    function showDeleteOptions(chatStorageKey, msgId, anchorEl){
      try{
        // toggle existing menu
        const existing = document.getElementById('deleteMenu_'+msgId);
        if(existing){ existing.remove(); return; }
        const menu = document.createElement('div');
        menu.id = 'deleteMenu_'+msgId;
        menu.style.display = 'inline-block';
        menu.style.marginLeft = '8px';
        const btn1 = document.createElement('button'); btn1.textContent = 'Delete for me'; btn1.style.marginRight='6px';
        // determine if current user is the sender of this message
        let isSender = false;
        try{
          const raw = localStorage.getItem(chatStorageKey) || '[]';
          const msgs = JSON.parse(raw);
          const found = (msgs || []).find(x=>x && x.id === msgId);
          const me = localStorage.getItem('currentUserId');
          if(found && me && String(found.senderId) === String(me)) isSender = true;
        }catch(e){ isSender = false; }
        btn1.onclick = function(e){ e.stopPropagation(); deleteForMe(chatStorageKey, msgId); menu.remove(); };
        menu.appendChild(btn1);
        if(isSender){
          const btn2 = document.createElement('button'); btn2.textContent = 'Delete for everyone';
          btn2.onclick = function(e){ e.stopPropagation(); deleteForEveryone(chatStorageKey, msgId); menu.remove(); };
          menu.appendChild(btn2);
        }
        anchorEl.appendChild(menu);
        // auto remove after a short time
        setTimeout(()=>{ try{ menu.remove(); }catch(e){} }, 8000);
      }catch(e){}
    }

    function deleteForMe(chatStorageKey, msgId){
      try{
        const me = localStorage.getItem('currentUserId'); if(!me) return;
        const hiddenKey = 'chat_hidden_' + String(me) + '_' + chatStorageKey;
        let arr = [];
        try{ arr = JSON.parse(localStorage.getItem(hiddenKey) || '[]'); }catch(e){ arr = []; }
        if(arr.indexOf(msgId) === -1) arr.push(msgId);
        localStorage.setItem(hiddenKey, JSON.stringify(arr));
        renderMessages();
      }catch(e){}
    }

    function deleteForEveryone(chatStorageKey, msgId){
      try{
        const raw = localStorage.getItem(chatStorageKey) || '[]'; let msgs = [];
        try{ msgs = JSON.parse(raw); }catch(e){ msgs = []; }
        const me = localStorage.getItem('currentUserId');
        const target = (msgs || []).find(x=>x && x.id === msgId);
        if(!target) return;
        if(!me || String(target.senderId) !== String(me)){
          // not sender, fallback to delete-for-me
          deleteForMe(chatStorageKey, msgId);
          return;
        }
        let changed = false;
        for(let i=0;i<msgs.length;i++){
          if(msgs[i] && msgs[i].id === msgId){
            msgs[i].deleted = true;
            msgs[i].deletedBy = me || 'me';
            msgs[i].deletedTs = Date.now();
            msgs[i].type = 'text'; msgs[i].content = 'This message was deleted'; msgs[i].data = null; msgs[i].filename = null;
            changed = true; break;
          }
        }
        if(changed){
          localStorage.setItem(chatStorageKey, JSON.stringify(msgs));
          try{ localStorage.setItem('chat_update_signal', Date.now().toString()); }catch(e){}
          renderMessages();
        }
      }catch(e){}
    }

    // bulk action bindings (register once)
    try{
      bulkDeleteForMeBtn.addEventListener('click', function(){
        try{
          const key = chatKey(localStorage.getItem('currentUserId'), currentTeacherId);
          const arr = Array.from(selectedMsgs);
          arr.forEach(id => deleteForMe(key, id));
          selectedMsgs.clear(); updateSelectionUI(); renderMessages();
        }catch(e){}
      });
      bulkDeleteForEveryoneBtn.addEventListener('click', function(){
        try{
          const key = chatKey(localStorage.getItem('currentUserId'), currentTeacherId);
          const arr = Array.from(selectedMsgs);
          arr.forEach(id => deleteForEveryone(key, id));
          selectedMsgs.clear(); updateSelectionUI(); renderMessages();
        }catch(e){}
      });
      cancelSelectionBtn.addEventListener('click', function(){ selectedMsgs.clear(); updateSelectionUI(); renderMessages(); });
    }catch(e){}
  })();
</script>

</body>
</html>
